# Codebase Structure

**Analysis Date:** 2026-02-10

## Directory Layout

```
/home/xndr/Work/Spicetify-Extension/
├── src/                         # TypeScript source code
│   ├── app.tsx                  # Extension background initialization
│   ├── app/                     # Custom app UI code
│   │   ├── index.tsx            # Root React component (StatsPage)
│   │   ├── components/          # UI components
│   │   ├── styles.ts            # CSS injection and styling
│   │   ├── icons.ts             # SVG icon definitions
│   │   └── utils.ts             # Component utilities (like detection, queue)
│   ├── services/                # Business logic and external integrations
│   │   ├── providers/           # Provider pattern implementations
│   │   │   ├── types.ts         # TrackingProvider interface
│   │   │   ├── index.ts         # Provider registry
│   │   │   ├── local.ts         # IndexedDB provider
│   │   │   ├── lastfm.ts        # Last.fm provider
│   │   │   └── statsfm.ts       # stats.fm provider
│   │   ├── stats.ts             # Stats calculation and caching
│   │   ├── tracker.ts           # Player event tracking
│   │   ├── storage.ts           # IndexedDB management
│   │   ├── spotify-api.ts       # Spotify Web API client
│   │   ├── lastfm.ts            # Last.fm API client
│   │   ├── statsfm.ts           # stats.fm API client
│   │   ├── updater.ts           # Version checking
│   │   ├── export.ts            # Data export utilities
│   │   ├── share-card.ts        # Share card generation
│   │   ├── playlist.ts          # Playlist operations
│   │   └── [future services]    # preferences, trends, goals, milestones, etc.
│   ├── types/                   # TypeScript definitions
│   │   ├── index.ts             # Barrel export
│   │   ├── listeningstats.ts    # Core data types
│   │   └── spotify.ts           # Spotify type definitions
│   └── utils/                   # Shared utilities (empty, reserved)
├── dist/                        # Build outputs
│   ├── listening-stats.js       # Extension bundle (~62kb)
│   ├── index.js                 # Custom app bundle (~222kb)
│   └── manifest.json            # Spicetify manifest
├── .planning/                   # GSD planning documents
│   └── codebase/                # This directory
├── package.json                 # Node dependencies and scripts
├── tsconfig.json                # TypeScript configuration
├── manifest.json                # Spicetify extension manifest (src)
└── [other]: README.md, CHANGELOG.md, Development.md
```

## Directory Purposes

**src/:**
- Purpose: All TypeScript source code, built by esbuild into two bundles
- Contains: Extension entry, custom app UI, services, types
- Key files: `app.tsx` (extension), `app/index.tsx` (app UI)

**src/app/:**
- Purpose: Custom app UI code (React components, styles, utilities)
- Contains: StatsPage root component, UI component tree, styling
- Key files: `index.tsx` (root), `components/` (component library), `styles.ts` (CSS), `utils.ts` (helpers)

**src/app/components/:**
- Purpose: Reusable React components for stats display
- Contains: Functional components (Header, TopLists, ActivityChart, OverviewCards, etc.), modal components (SettingsPanel, ShareCardModal, SetupScreen)
- Pattern: Barrel export via `index.ts`, each component in own file
- Dependencies: styles.ts, icons.ts, parent state props

**src/services/:**
- Purpose: Business logic, data transformation, external API clients
- Contains: Stats calculation, tracking, storage, provider implementations, external API integrations
- Entry point: Provider registry (providers/index.ts), stats calculation (stats.ts)

**src/services/providers/:**
- Purpose: Pluggable data source implementations
- Contains: TrackingProvider interface, factory functions for each provider, shared aggregation logic
- Key files: `types.ts` (interface), `index.ts` (registry), `local.ts`, `lastfm.ts`, `statsfm.ts` (implementations)
- Pattern: Each provider file exports `createXxxProvider()` function

**src/types/:**
- Purpose: TypeScript type definitions and interfaces
- Contains: Core data shapes (ListeningStats, PlayEvent, PollingData), Spotify types, provider interface
- Key files: `listeningstats.ts` (main types), `index.ts` (barrel export), `spotify.ts` (Spotify API types)

**dist/:**
- Purpose: Build outputs for Spicetify
- Contents: `listening-stats.js` (extension 62kb IIFE), `index.js` (custom app 222kb IIFE), `manifest.json` (Spicetify metadata)
- Generated by: `npm run build` (esbuild)

## Key File Locations

**Entry Points:**
- `src/app.tsx`: Extension background initialization, provider auto-activation on startup
- `src/app/index.tsx`: Root React component (StatsPage class), manages page-level state

**Configuration:**
- `manifest.json`: Spicetify app metadata (name, description, routes)
- `package.json`: Node dependencies (idb, esbuild, typescript, spicetify-creator)
- `tsconfig.json`: TypeScript compiler options

**Core Logic:**
- `src/services/providers/index.ts`: Provider registry, activation logic
- `src/services/stats.ts`: Stats caching and delegated calculation
- `src/services/tracker.ts`: Player event listeners and play logging
- `src/services/storage.ts`: IndexedDB abstraction

**UI Components:**
- `src/app/components/`: All UI components (import via barrel export `index.ts`)
- `src/app/styles.ts`: Global CSS injection and theme variables
- `src/app/icons.ts`: SVG icon definitions

**External Integrations:**
- `src/services/spotify-api.ts`: Spotify Web API client (with rate limiting, caching, queuing)
- `src/services/lastfm.ts`: Last.fm API client
- `src/services/statsfm.ts`: stats.fm API client

**Type Definitions:**
- `src/types/listeningstats.ts`: ListeningStats, PlayEvent, PollingData, provider types
- `src/types/spotify.ts`: Spotify API response types

## Naming Conventions

**Files:**
- `camelCase.ts` or `camelCase.tsx` for all source files
- Component files named after component: `SettingsPanel.tsx` contains `SettingsPanel` component
- Provider files: `{provider-name}.ts` (local.ts, lastfm.ts, statsfm.ts)
- Utility/service files: descriptive name (tracker.ts, storage.ts, spotify-api.ts)
- No index files except barrel exports (`index.ts` in components/ and types/)

**Directories:**
- `camelCase` for directories: `app`, `components`, `services`, `providers`, `types`
- Snake_case in config: `.planning`, `.vscode`, `.github`, etc.

**Functions:**
- camelCase: `calculateStats()`, `getActiveProvider()`, `initPoller()`
- Prefix conventions:
  - get: `getActiveProvider()`, `getSelectedProviderType()`, `getPollingData()`
  - set: `setSelectedProviderType()`, `setLoggingEnabled()`
  - create: `createLocalProvider()`, `createLastfmProvider()`
  - is/has: `isLoggingEnabled()`, `hasExistingData()`
  - on: `onStatsUpdated()` (subscription pattern)

**Variables:**
- camelCase: `statsCache`, `activeProvider`, `currentTrackUri`, `pollIntervalId`
- UPPER_CASE for constants: `STORAGE_KEY`, `CACHE_TTL_MS`, `MAX_BATCH`, `PERIODS`
- Prefixes for state management: `localStorage.getItem("listening-stats:...")` uses "listening-stats:" namespace

**Types & Interfaces:**
- PascalCase: `ListeningStats`, `TrackingProvider`, `PlayEvent`, `ProviderType`
- Type aliases: `type ProviderType = "local" | "lastfm" | "statsfm"`
- Interface pattern: `interface TrackingProvider { ... }`

## Where to Add New Code

**New Feature (Stats metric, component):**
- Primary code: `src/services/` if data logic, `src/app/components/` if UI
- Provider integration: Update `TrackingProvider.calculateStats()` implementation in each provider (local.ts, lastfm.ts, statsfm.ts)
- Type definition: Add to `src/types/listeningstats.ts` in ListeningStats interface
- UI component: Create in `src/app/components/{FeatureName}.tsx`, export from `src/app/components/index.ts`
- Tests: None enforced yet, but would go to `{file}.test.ts` co-located with source

**New Provider:**
- Implementation: Create `src/services/providers/{provider-name}.ts`
- Export factory function: `export function create{Provider}Provider(): TrackingProvider { ... }`
- Registry: Add case to switch in `src/services/providers/index.ts` activateProvider()
- Type: Add to union `type ProviderType = "local" | "lastfm" | "statsfm" | "new-provider"`
- API client: Create `src/services/{provider-name}.ts` for API calls if external service

**Utilities/Helpers:**
- Shared service logic: `src/services/{name}.ts` (e.g., export.ts, share-card.ts, playlist.ts)
- Component utilities: `src/app/utils.ts`
- Type utilities: `src/types/{name}.ts` or extend existing types file
- Never use `src/utils/` (reserved, currently empty)

**New External Integration:**
- API client: `src/services/{service-name}.ts` with getConfig/saveConfig if credentials needed
- Provider adapter: `src/services/providers/{service-name}.ts` implementing TrackingProvider
- Config storage: localStorage key "listening-stats:{service-name}"

## Special Directories

**dist/:**
- Purpose: Build artifacts
- Generated: Yes, by `npm run build` (esbuild)
- Committed: Yes, dist files are committed to git for distribution
- Contents: Two IIFE bundles + manifest.json

**.planning/:**
- Purpose: GSD (Guided Software Development) planning documents
- Generated: No, manually created by gsd map-codebase and gsd plan-phase
- Committed: Yes
- Structure: `.planning/codebase/` contains ARCHITECTURE.md, STRUCTURE.md, etc.

**node_modules/:**
- Purpose: Installed dependencies
- Generated: Yes, by `npm install`
- Committed: No (in .gitignore)
- Key dependency: `idb` (IndexedDB wrapper)

## Build Output

**Two bundles generated by esbuild:**

1. **dist/listening-stats.js** (~62kb)
   - Built from: `src/app.tsx`
   - Format: IIFE (Immediately Invoked Function Expression)
   - Purpose: Extension background script, auto-runs on Spicetify load
   - Externals: React, React-DOM (provided by Spicetify)

2. **dist/index.js** (~222kb)
   - Built from: `src/app/index.tsx`
   - Format: IIFE with global name `ListeningStatsApp`
   - Purpose: Custom app render function
   - Template: Esbuild footer adds render() and routes export for Spicetify

3. **dist/manifest.json**
   - Source: `manifest.json` (copied)
   - Spicetify app metadata: name, description, routes, icon

## Code Organization Principles

**Provider Pattern:**
- All data sources implement `TrackingProvider` interface
- Implementations are independent, no shared state between providers
- Registry (`providers/index.ts`) manages lifecycle (activate/destroy)
- Consumers use `getActiveProvider()` for current provider

**Service Layer:**
- Services export pure functions or factory functions
- Configuration stored in localStorage with try-catch guards
- Caching done at service level (spotify-api.ts, lastfm.ts, stats.ts)
- No shared global state except for singletons (activeProvider, cache)

**Component Tree:**
- Root: `StatsPage` class component manages all page state
- Children: Functional components receive state + callbacks via props
- Modals: Rendered via `ReactDOM.createPortal` to document.body (avoids transform stacking context issues)
- No Redux/context API (kept minimal, single root component)

**Type Safety:**
- All data types defined in `src/types/listeningstats.ts`
- Provider interface is single source of truth for provider contract
- TypeScript strict mode helps catch errors early

---

*Structure analysis: 2026-02-10*
